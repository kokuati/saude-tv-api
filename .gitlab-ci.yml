# Node docker image on which this would be run
image: node:latest

cache:
  paths:
    - node_modules/

stages:
  - test
  - deploy_release
  - deploy_feature
  - deploy_production

# Job 1:
Test:
  stage: test
  cache:
    key: modules
    policy: push
    paths:
      - node_modules/
  before_script:
    - yarn install
  script:
    - yarn test

# Job 2:
# Deploy to staging
Release: &deploy
  image: ruby:latest
  variables:
    CNAME: release-bora
  stage: deploy_release
  script:
    - apt-get update -qy
    - apt-get install -y ruby-dev
    - gem install dpl
    - dpl --provider=heroku --app=${CNAME} --api-key=$HEROKU_API_KEY
  only:
    - /^release\/.*$/

Feature:
  <<: *deploy
  variables:
    CNAME: feature-bora
  stage: deploy_feature
  only:
    - /^feature\/.*$/

Production:
  <<: *deploy
  variables:
    CNAME: bora-app
  stage: deploy_production
  only:
    - master
